clear all
close all
clc

tic
%% Define vehicle
R = 0.05; % Wheel Radius [m]
L = 0.18; % Wheel base [m]
dd = DifferentialDrive(R,L);

%% Simulation parameters
sampleTime = 0.1; % Sample time [s]
tVec = 0:sampleTime:3500; % Time array

% Define waypoints
waypoints = [
-159.2823536941158,-37.0047443694351; -163.3653180168765,-10.8057232983871; -168.8092704472242,6.8871221002428; -173.5727288237784,23.8994734450792; -172.892234769985,42.9533069512959; -171.5312466623981,67.4510928878603; -169.4897645010177,89.9073966630444; -168.8092704472242,115.7661707071957; -160.6433418017027,135.5004982672059; -148.3944488334204,156.595813934803; -142.9504964030728,183.1350820327478; -139.5480261341055,201.5084214851711; -136.1455558651382,223.2842312065616; -115.0502401975409,238.9355944438111; -100.0793710140848,237.5746063362242; -85.7889958844222,238.9355944438111; -73.5401029161399,253.2259695734737; -56.5277515713035,253.9064636272671; -41.5568823878474,254.5869576810606; -26.5860132043913,246.4210290355391; 0,250; 21.7290646149443,251.1844874120933; 46.2268505515089,240.296582551398; 54.3927791970304,232.81114795967; 73.4466127032472,233.4916420134635; 87.0564937791164,224.6452193141485; 94.5419283708445,211.0353382382795; 93.1809402632575,192.6619987858561; 99.3053867473987,177.6911296024001; 108.1518094467136,162.7202604189441; 118.3592202536155,147.7493912354881; 126.525148899137,134.8200042134124; 131.9691013294847,115.7661707071957; 133.3300894370716,99.4343134161527; 136.0520656522455,83.7829501789033; 138.0935478136258,70.8535631568276; 138.7740418674193,47.0362712740567; 138.7740418674193,31.3849080368072; 136.7325597060389,13.6920626381773; 136.0520656522455,-0.5983124914852; 138.0935478136258,-14.2081935673543; 138.7740418674193,-27.8180746432234; 149.6619467281146,-29.8595568046038; 158.8525566548744,-26.526331450662; 164.9592049891414,-18.3841336716394; 167.5763399895415,-9.9511431147945; 167.5763399895415,-0.645774224483; 167.5763399895415,8.9503874436508; 166.4131688782526,18.2557563339623; 168.157925545186,26.9795396686294; 170.1934749899417,36.8664941145854; 171.9382316568751,46.7534485605414; 172.2290244346973,55.1864391173862; 170.1934749899417,61.8746730072977; 168.157925545186,68.2721141193868; 165.8315833226081,76.7051046762317; 162.9236555443858,83.3933385661431; 160,80; 155.9446288766521,73.7971768980093; 151.2919444314963,66.8181502302757; 148.0932238754517,60.1299163403642; 150.8535524583865,57.4354007859497; 155.4580463260326,52.6307115327538; 155.6582417115825,43.8221145685612; 156.4590232537818,33.2117591344202; 155.057655554933,25.8045298690764; 151.6543340005859,20.7996452303306; 146.0488632051906,23.6023806280283; 146.8496447473899,32.0105868211212; 146.4492539762902,43.4217237974615; 145.4482770485411,51.8299299905545; 166.0095569186602,88.3310491646487; 170.089995603217,102.3211246545577; 171.8035387239975,118.8137329123886; 170.5195971725128,129.085265324266; 171.1615679482551,142.5666516148552; 171.1615679482551,156.6900086811867; 168.5936848452858,170.1713949717759; 167.3097432938011,183.6527812623651; 164.7418601908317,201.6279629831507; 159.6060939848929,214.4673784979975; 150.6185031245001,227.9487647885867; 148.0506200215307,237.5783264247218; 142.914853815592,253.6275958182804; 134.5692337309415,265.1830697816425; 121.0878474403522,278.6644560722317; 109.53237347699,291.5038715870786; 100,300; 83.8535424472962,309.4790533078641; 68.44624382948,316.5407318410299; 54.3228867631484,321.6764980469686; 38.2736173695897,326.8122642529073; 22.8663187517735,329.3801473558767; 6.8170493582148,331.3060596831037; -11.1581323625708,332.5900012345884; -27.2074017561294,331.9480304588461; -47.1084958041421,331.9480304588461; -64.4417067491855,331.3060596831037; -86.9106839001675,327.4542350286497; -106.1698071724379,323.6024103741956;
-129.9227258749046,310.7629948593488; -143.4041121654939,297.923579344502; -149.181849147175,287.6520469326245; -154.9595861288561,273.528689866293; -154.9595861288561,259.4053327999615; -150,250; -136.9844044080705,249.7757711638263; -128.6387843234199,242.7140926306605; -141.9141779049681,245.8361510798167; -155.2593724296078,246.5205200297982; -168.1604278257053,234.4099802329249; -179.3938579056843,224.7813258786572; -189.0225122599521,211.4081948310631; -200,200; -205.070269517065,179.8476055587412; -209.3496714522951,164.8696987854358; -212.0242976618139,150.961642495938; -212.5592229037177,134.9138852388252; -211.4893724199102,116.1915017721935; -206.6750452427763,99.0738940312732; -198.116241372316,81.421361048449; -189.5574375018558,70.7228562103738; -181.5335588732994,62.1640523399136; -178.7458745460049,52.4269671404275; -183.1207820432823,56.8018746377049; -187.183196147897,63.9892226689463; -192.4955838231624,66.4891698102477; -189.9956366818611,59.9268085643316; -188.7456631112104,53.6769407110782; -189.0581565038731,43.9896455385354; -190.3081300745237,32.7398834026793; -190.6206234671864,20.5526410888352; -191.5581036451744,8.365398774991; -190.4379104608773,-2.8365330679804; -190.4379104608773,-14.5985615031004; -185.9571377236887,-25.2403967539234; -180.356171802203,-33.641845636152; -171.3946263278258,-42.0432945183806; -154.8172263293201,-39.2874881277472; -159.6821907451751,-24.436544121453; -165.0592566784885,-1.6480265945532; -170.1802718530728,15.2513234815748; -173.2528809578233,37.5277394910161; -178.8859976498659,33.9430288688072; -182.7267590308041,26.2615061069308; -185.2872666180962,18.3239325863253; -182.7267590308041,12.4347651355534; -177.0936423387614,11.1545113419074; -170.6923733705312,11.4105621006366; -167.3637135070514,2.7048363038434; -161.986647573738,-16.2429198421182; -159.6821907451751,-30.3257115722248; -155.5853786055077,-46.4569093721651; -152.0740272646282,-58.3921273842773; -145.6272402914813,-71.7461861143674; -137.7989989669457,-84.6397600606614; -128.5893032910214,-96.6123644393628; -119.3796076150971,-109.0454536018606; -108.3279728039881,-118.715634061581; -94.9739140738979,-127.9253297375052; -83.0013096951964,-137.1350254134295; -70.1077357489024,-145.8842363055575; -62.2794944243668,-151.8705384949082; -52.1488291808501,-156.0149015490741; -44.3205878563145,-159.6987798194438; -30.9665291262243,-164.7641124412021; -13.0076225581721,-167.9875059277756; -3.3374420984516,-167.9875059277756; -2.4164725308592,-154.6334471976855; -3.7979268822478,-139.4374493324105; -5.1793812336364,-118.715634061581; -6.1003508012289,-99.8357579259363; -7.4818051526175,-80.0349122226992; -8.4027747202099,-63.9179447898318; -18.9939247475228,-65.2993991412205; -35.1108921803903,-63.4574600060356; -43.8601030725183,-61.6155208708508; -55.3722226674236,-58.3921273842773; -63.2004639919592,-53.326794762519; -70.1077357489024,-47.3404925731682; -80,-40; -65.5028879109403,-33.9864338430781; -53.990768316035,-30.7630403565046; -42.4786487211297,-27.5396468699311; -29.5850747748357,-26.6186773023387; -18.9939247475228,-25.6977077347463; -13.3898471178075,-28.7906675143851; -14.2586432026261,0.9655983906492; -20.9918128599696,3.3547876239002; -27.0733854536992,7.0471709843789; -32.2861619626104,9.8707582600391; -37.9333365139308,12.0427484720854; -43.5805110652511,11.6083504296761; -47.9244914893437,8.133166090402; -43.7977100864558,7.2643700055835; -40.3225257471817,7.2643700055835; -40.7569237895909,3.7891856663094; -46.4040983409113,2.9203895814909; -50.9652777862086,3.1375886026955; -56.8296513587336,6.395573920765;
-63.3456219948725,13.5631416205178; -63.1284229736679,21.1651073626798; -59.4360396131891,28.115476041228; -55.0920591890965,35.0658447197762; -50.7480787650039,42.4506114407336; -44.6665061712743,49.835378161691; -35.9832699970534,57.5430360657005; -31.5477497277155,69.8991282445702; -30.914103974953,82.2552204234399; -30.914103974953,91.7599067148781; -30.914103974953,102.8487073882227; -30.914103974953,112.6702165560422; -32.5670497635152,121.8794502729205; -34.4394086608009,131.2412447593487; -40,140; -50.0423994715144,145.5959963052051; -60.028313590371,149.0286542835621; -71.2624669740847,150.5889533646334; -79.3760221956558,150.9010131808477; -89.9860559469409,151.213072997062; -101.5322691468689,149.9648337322049; -108.0855252873686,150.2768935484191; -117.759379590011,148.0924748349192; -126.1849946277963,144.0356972241337; -132.4261909520817,139.3547999809197; -139.2915069087956,134.3618429214914; -145.2206434168667,126.8724073323489; -148.0291817627952,120.6312110080635; -148.0291817627952,115.3261941324209; -144.3916075917701,114.5319922943208; -138.2144375923706,114.3650417537965; -130.5347127282524,114.3650417537965; -124.0236416478044,118.2049041858556; -119.0151254320751,122.0447666179147; -112.3371038111028,126.3854806715467; -105.6590821901304,129.5575409415086; -98.1463078665366,130.0583925630815; -90,130; -82.7868581383002,129.5575409415086; -73.6045784094632,127.7210849957412; -66.0918040858693,125.7176785094495; -60.2485351675185,124.2151236447307; -53.7374640870704,122.3786676989633; -46.8924919255738,119.0396568884772; -40.54837138565,116.3684482400882; -33.7033992241534,114.1980912132722; -30,110; -31.3660916568131,99.0055920255601; -34.037300305202,91.4928177019662; -53.7374640870704,91.8267187830148; -57.5773265191295,101.676800673949; -63.253644896956,107.0192179707269; -70,110; -77.7783419225709,114.3650417537965; -86.1258689487863,115.700646077991; -95.8090002991962,115.0328439158937; -104.8243294875089,113.029437429602; -113.1718565137243,110.0243277001645; -119.3490265131238,105.6836136465325; -125.0253448909503,101.676800673949; -130.3677621877282,95.3326801340253; -134.0406740792629,89.4894112156745; -128.6982567824851,83.6461422973237; -120,80; -111.3354005679569,80.3071314868375; -104.8243294875089,79.3054282436917; -98.1463078665366,79.3054282436917; -96.9776540828664,85.6495487836154; -100.4836154338769,87.6529552699071; -103.1548240822658,91.9936693235391; -103.9895767848874,98.3377898634629; -99.8158132717796,102.3446028360463; -94.8072970560504,103.0124049981435; -89.9657313808454,103.5132566197164; -85.7919678677377,103.6802071602407; -80.7834516520084,103.1793555386678; -79.447847327814,98.0038887824142; -80.1156494899112,94.3309768908795; -80.6165011114841,91.8267187830148; -83.2877097598731,88.3207574320043; -88.2962259756023,86.9851531078099; -91.4682862455642,85.8164993241397; -98.4802089475852,83.4791917567994; -94.8072970560504,78.8045766221187; -90,80; -81.9521054356786,79.472378784216; -75.4410343552306,81.642735811032; -68.2621611126853,83.813092837848; -61.9180405727616,86.9851531078099; -56.5756232759837,90.1572133777717; -43.5534811150876,92.1606198640634; -37.2093605751639,91.4928177019662; -30.8652400352401,86.9851531078099; -30,80; -4.9879062539723,80.9749336489348; -4.6390382328783,91.9568187395571; -4.6390382328783,100.9229809448483; -3.7050630031605,110.2627332420266; -3.1446778653298,118.1081251716564; -1.4635224518377,128.0082626066655;
0.9648131454287,135.2932693984645; 5.6346892940178,143.8858415118686; 13.6668762695912,147.2481523388528; 22.1291505082158,148.3865783400542; 29.1891031151842,148.8734716232934; 37.4662889302506,149.8472581897718; 46.4738146701759,152.5251712475874; 55.2378937684815,156.6637641551206; 64.0019728667871,158.3678906464578; 75.687411664528,158.6113372880774; 82.990810913116,154.7161910221638; 89.3204235952257,151.0644913978698; 95.1631429940961,146.9258984903366; 102.9534355259233,141.5700723747054; 108.5527082831741,134.0232264844978; 114.3954276820445,126.2329339526706; 116.8298940982406,119.4164279873218; 113.4216411155662,115.5212817214082; 103.9272220924017,120.3902145538002; 97.8410560519117,126.9632738775294; 91.5114433698021,132.075653351541; 85.6687239709316,135.9707996174546; 79.5825579304416,136.2142462590742; 73.4963918899516,138.161819392031; 67.6536724910812,140.1093925249878; 55.4813404101011,137.9183727504114; 44.5262415372191,134.510119767737; 35.7621624389134,132.8059932763998; 24.5636169244118,132.075653351541; 14.5823046180081,129.3977402937254; 8.9830318607573,125.5025940278118; -1.883725714997,124.2875185446903; -2.6916183121017,115.2391214571176; -3.0147753509436,106.3523028889658; -3.9842464674693,97.7886413596559; -2.2068827538389,91.1639220633973; 3.609943945315,91.971814660502; 9.5883491638899,92.1333931799229; 15.4051758630438,92.6181287381858; 17.0209610572532,97.303905801393; 20.0909529262511,102.4744184228632; 24.2919944311956,107.3217740054914; 30.2703996497704,112.6538651463825; 35.2793337518197,115.4006999765385; 43.6814167617086,118.6322703649573; 51.4371856939139,119.9248985203249; 58.0619049901725,119.601741481483; 65.6560954029568,119.601741481483; 73.0887072963201,119.2785844426411; 77.7744843595274,116.693328131906; 83.1065755004185,114.5928073794338; 86.8431530815014,110.8859720124982; 90.7389836439871,106.9901414500125; 94.4297704926577,102.2741360322667; 98.3256010551434,96.7379557592608; 100.7861256209238,94.2774311934803; 94.8398579202878,89.9715132033646; 87.4582842229465,86.8958574961391; 78.2313171012699,84.6403766441737; 72.2850494006338,83.4101143612835; 65.7236505585527,82.7949832198383; 62.4429511375121,82.5899395060233; 61.2126888546218,87.3059449237691; 65.9286942723677,92.8421251967751; 68.1841751243331,99.6085677526713; 65.1085194171075,103.5043983151569; 62.6479948513271,105.7598791671223; 57.9319894335813,106.9901414500125; 53.4210277296505,106.7850977361975; 47.8848474566445,105.7598791671223; 43.9890168941588,102.2741360322667; 43.7839731803438,98.3783054697811; 45.6293666046791,94.6875186211104; 48.4999785980896,92.0219503415149; 51.7806780191302,90.9967317724398; 55.0613774401708,90.3816006309947; 59.1622517164715,90.3816006309947; 60.9464373468983,84.8060205359108; 59.8313213278815,81.9067188864673; 55.5938804556178,82.0182304883689; 49.5722539529272,82.9103233035823; 43.439115848335,83.8024161187958; 38.3095821608579,84.6945089340092; 34.1836528904958,86.3671829625343; 29.5001656106254,88.5974150005678; 24.5936551269516,90.3816006309947; 20.2447026527862,92.2772978633232; 13.5540065386856,93.9499718918483; 7.9784264436017,94.396018299455; 2.0683115428129,94.6190415032584; -5.2914541826978,87.1477641758461; -5.2914541826978,74.3153088383379; -2.0087330498469,67.4514373787405; 3.9598508280639,58.7969907557699; 10.8237222876614,52.8284068778591; 17.0907353594677,47.755110581635; 20,40; 27.8341863397071,33.7289384685446; 32.6090534420358,28.3572129784249; 36.1902037687823,20.5980539371409;
33.2059118298269,12.8388948958569; 27.8341863397071,8.6608861813194; 22.4624608495874,7.7655985996327; 13.5095850327212,7.4671694057372; 9.3311360583724,7.351101378672; 10.6078843560901,11.7616864071513; 14.0899251680474,12.6902306236732; 19.545122440114,12.3420265424775; 13.393517005656,15.3597952461739; 8.2865238147852,15.1276591920434; 4.2241428675016,13.1545027319342; 1.7331439039541,10.7275330086974; -1.8101735569749,8.1616824335419; -5.5978577393473,5.2292817762213; -8.7746251181112,3.1521646439526; -10,0; -9.5077252824414,-28.2489590615216; 2.2218773468409,-26.1718419292528; 13.7071132546797,-24.950008322036; 23.1152320302498,-25.6831084863661; 33.1342676094284,-26.5383920114179; 44.3751367958239,-27.7602256186348; 52.8057886856205,-29.8373427509035; 60,-30; 56.2897846631607,-35.9964846392755; 49.3608591079113,-35.9964846392755; 41.1327600110526,-35.779955715674; 33.337718761397,-36.213013562877; 24.6765618173353,-36.8626003336817; 15.798875949672,-38.3783027988925; 6.0550743876025,-40.7601209585095; -2.1730247092562,-44.4411126597357; -11.0507105769195,-45.7402862013449; -18.6292229029736,-44.8741705069388; -27.0738509234338,-43.7915258889311; -37.4672392563079,-42.7088812709233; -46.7779829711743,-43.7915258889311; -56.0887266860407,-44.4411126597357; -62.151536546884,-44.8741705069388; -74.5559626521495,-43.6366451076402; -67.7504382677993,-49.9781564657847; -60.171558839773,-56.0103258064587; -50,-60; -28.773344066521,-64.3625602781611; -14.3889402541445,-66.0639413742487; -3.2526276252078,-65.2905863305725; 4.3262518028185,-63.589205234485; 12.678486274521,-60.6504560685156; 21.340062763694,-57.557035893811; 27.372232104368,-53.8449316841654; 33.7137434625125,-49.6688144483142; 41.2926228905389,-45.6473682211982; 48.5621603010947,-41.7805930028174; 37.3881236729198,-48.1126439496577; 30.6452329959513,-52.0834573483168; 23.9772633265047,-56.054270746976; 17.0845306344926,-59.2009530628946; 9.7621358337945,-62.1841509446605; 0,-65; -6.5089157924516,-64.5856354819508; -7.1272393933193,-88.7002559157939; -5.9936491255723,-109.1189430823799; -5.7689452470667,-130.6905154189251; -3.2972025835042,-143.7233403722544; -2.597833989931,-161.5747263705196; -0.1191651805532,-169.473008801312; 13.5686106596931,-168.8313943088005; 26.400900509924,-165.1955788512351; 40,-160; 51.2099942203703,-151.7216745084928; 64.0422840706012,-142.0974571208198; 75.5913449358091,-130.3345247581082; 88.8513777810476,-118.9993353904044; 101.8975391287824,-104.2422020626391; 109.5559222594026,-90.7274083027209; 120.8182503926678,-77.2126145428028; 130.2786060246106,-64.1483139082153; 134.3330441525861,-51.0840132736278; 138.3874822805616,-36.2177401377179; 138.7490285816818,-22.3946137936688; 136.975509289902,-42.2020239266042; 125.4876002770675,-68.8992772662897; 115.6177066181533,-86.5356446240214; 111.8962713041365,-94.3021183228391; 111.8962713041365,-101.5831874154806; 117.8988075440108,-107.3435298561356; 127.0460521493821,-121.8715065823134; 135.6552235426728,-137.4756297326526; 141.5186495168613,-148.9001422587762; 147.6881570045456,-160.2109059861974; 155.7427917801334,-175.6346747054081; 181.7345627631242,-189.808730355826; 223.4048124741089,-215.1085248232093; 263.5868389811299,-238.1759844846471; 314.186427915897,-270.1727833698672; 357.3449008308455,-293.9843546332868; 394.5504809299389,-317.7959258967064; 408.6886013675945,-329.7017115284162; 425.8031682131775,-346.0721667720172; 433.9883958349781,-363.9308452195819;
450,-400; 480,-500; -460.8284209464694,-498.6649646656321; -412.0379980504255,-368.5571702761826; -402.2956139234487,-347.2866901838884; -393.8423818458687,-334.1978147089258; -150.9834609868785,-182.0774428554769; -120,-120; -110.629876491974,-155.9141298313083; -95.1092670708569,-190.9463625246866; -70.7197379805299,-230.4130550526698; -50,-250; -36.2671861108309,-266.5357269951212; -24.6732783945003,-280.5704573885739; 9.4982390852109,-340.9808186473483; 84.5535364067196,-227.482564161166; 102.2495008158557,-182.3273446344053; 111.4025858550641,-149.9864441625362; 114.0117616115754,-104.8188188116517; 160,-180; 175.03196181816,-221.1889776793013; 185.9325973581354,-295.3132993511329; 107.4480214703129,-228.8194225572839; 98.1824812613339,-262.0663609542084; 71.4759241883943,-281.6875049261638; 1.3919853877866,-373.0562679866011; -99.6413275658201,-256.7148773127523; -161.4859615556036,-306.3130491263405; -156.9791984866992,-195.0899179133181; -121.1833329284679,-122.824494400147];

initPose = [waypoints(1,1);waypoints(1,2); -pi]; % Initial pose (x, y, theta)
pose = zeros(3, numel(tVec)); % Pose matrix
pose(:,1) = initPose;

% Create visualizer
viz = Visualizer2D;
viz.hasWaypoints = true;

%% Pure Pursuit Controller
controller = controllerPurePursuit;
controller.Waypoints = waypoints;
controller.LookaheadDistance = 0.4;
controller.DesiredLinearVelocity = 2.5;
controller.MaxAngularVelocity = 4;
wL_array = [];
wR_array = [];

%% Simulation Loop
close all
r = rateControl(1/sampleTime);
for idx = 2:numel(tVec)
    % Run the Puse Pursuit controller and convert output to wheel speeds
    [vRef, wRef] = controller(pose(:,idx-1));
    [wL, wR] = inverseKinematics(dd, vRef, wRef);
    
    wL_array = [wL_array, wL];
    wR_array = [wR_array, wR];

    % Compute the velocities
    [v, w] = forwardKinematics(dd, wL, wR);
    velB = [v;0;w]; % Body velocities [vx;vy;w]
    vel = bodyToWorld(velB, pose(:,idx-1)); % Convert from body to world

    % Perform forward discrete integration step
    pose(:, idx) = pose(:, idx-1) + vel*sampleTime;

    % Update visualization
    %viz(pose(:,idx), waypoints)
    %waitfor(r);
end

plot(pose(1,:), pose(2,:), 'k', 'LineWidth', 2);
axis([-500 500 -500 500]);  % Limita los ejes X y Y
axis square;                % Fuerza que el aspecto de la gr√°fica sea cuadrado

toc